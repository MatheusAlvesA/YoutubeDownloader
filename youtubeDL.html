<?php

$infos_query = get_infos_raw($_GET['v']);

$dados = tratar_dados(get_download_urls($infos_query));

?>

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <title>Youtube Downloader</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="shortcut icon" type="image/png" href="https://s.ytimg.com/yts/img/favicon_144-vfliLAfaB.png"/>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>

</head>

<body ng-app="App">

<nav class="navbar navbar-expand-sm navbar-toggleable-md bg-dark navbar-dark">
  <a class="navbar-brand" href="#">
    Youtube Downloader
  </a> 
</nav>

<br>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div id="tela_OpcoesDownload" class="container-fluid">
                <hr>
                <table class="table table-dark table-hover table-responsive-sm">
                    <thead>
                    <tr>
                        <td>Qualidade</td>
                        <td>Tipo</td>
                        <td>Download</td>
                    </tr>
                    </thead>
                    <tbody>
                    <?php 
                        foreach ($dados as $video) {
                            echo '<tr><td>'.$video['qualidade'].'</td>';
                            echo '<td>'.$video['tipo'].'</td>';
                            echo '<td><a href="'.$video['url'].'"><button class="btn btn-primary" style="cursor: pointer">Download</button></a></td></tr>';
                        }
                    ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    //todo
</script>
</body>
</html>

<?php
//ZONA DE FUNÇÕES

function get_download_urls($infos_query) {
    parse_str($infos_query, $infos);
    
    $streams_raw = explode(',', $infos['url_encoded_fmt_stream_map']);
    
    $streams = array_map(
        function($valor) {
            parse_str($valor, $temp);
            return $temp;
        }
    , $streams_raw);
    
    return $streams;
}

function tratar_dados($dados) {
    return array_map(function($dados){
        return [
                'qualidade' => $dados['quality'],
                'url' => $dados['url'],
                'tipo' => explode(';', $dados['type'])[0]
            ];
    }, $dados);
}

function get_infos_raw($cod) {
    $URL_YT_INFOS = 'http://youtube.com/get_video_info?video_id=';
    return file_get_contents($URL_YT_INFOS.$cod);
}
?>